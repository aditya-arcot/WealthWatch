name: Deploy in Docker
on:
    workflow_call:
        inputs:
            runner:
                required: true
                type: string
            repo:
                required: true
                type: string
            server_image:
                required: true
                type: string
            client_image:
                required: true
                type: string
            image_tag:
                required: true
                type: string

jobs:
    deploy:
        runs-on: ${{ inputs.runner }}
        environment: ${{ github.ref_name == 'main' && 'prod' || 'test' }}
        steps:
            - name: unlock keychain
              run: security unlock-keychain -p ${{ secrets.KEYCHAIN_PASSWORD }} login.keychain

            - name: checkout
              uses: actions/checkout@v3

            - name: setup node
              uses: actions/setup-node@v4
              with:
                  node-version: 'lts/*'
                  cache: 'npm'

            - name: install, build (server)
              run: |
                  cd server/
                  npm ci
                  npm run build

            - name: modify env.test.ts (client)
              if: github.ref_name == 'test'
              run: |
                  cd client/src/environments/
                  sed -e "s/{SERVER_PORT}/${{ secrets.SERVER_PORT}}/g" env.test.ts > env.test.ts.tmp
                  mv env.test.ts.tmp env.test.ts

            - name: install, build (client)
              run: |
                  cd client/
                  npm ci
                  if [ "${{ github.ref_name }}" == "main" ]; then
                    npm run build
                  else
                    npm run build:test
                  fi

            - name: create .env (server)
              run: |
                  cd server/

                  echo "CLIENT_LOGTAIL_TOKEN=${{ secrets.CLIENT_LOGTAIL_TOKEN }}" >> .env
                  echo "SERVER_LOGTAIL_TOKEN=${{ secrets.SERVER_LOGTAIL_TOKEN }}" >> .env

                  echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
                  echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
                  echo "DB_USER=${{ secrets.DB_USER }}" >> .env
                  echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env

                  echo "LOG_LEVEL=${{ secrets.LOG_LEVEL }}" >> .env
                  echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> .env
                  echo "CSRF_SECRET=${{ secrets.CSRF_SECRET }}" >> .env
                  echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> .env

                  echo "PLAID_ENV=${{ secrets.PLAID_ENV }}" >> .env
                  echo "PLAID_CLIENT_ID=${{ secrets.PLAID_CLIENT_ID }}" >> .env
                  echo "PLAID_SECRET=${{ secrets.PLAID_SECRET }}" >> .env
                  echo "PLAID_WEBHOOK_URL=${{ secrets.PLAID_WEBHOOK_URL }}" >> .env

                  echo "CLIENT_PORT=${{ secrets.CLIENT_PORT }}" >> .env
                  echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
                  echo "DOCKER_REGISTRY=${{ secrets.DOCKER_REGISTRY }}" >> .env
                  echo "KEYCHAIN_PASSWORD=${{ secrets.KEYCHAIN_PASSWORD }}" >> .env

            - name: copy files (server)
              run: |
                  cd server/
                  mkdir stage
                  cp -r .env Dockerfile package.json package-lock.json dist stage/

            - name: copy files (client)
              run: |
                  cd client/
                  mkdir stage
                  cp -r Dockerfile nginx.conf dist stage/

            - name: build, push docker image (server)
              run: |
                  cd server/stage/
                  IMAGE=${{ secrets.DOCKER_REGISTRY }}/${{ inputs.server_image }}:${{ inputs.image_tag }}
                  docker build -t $IMAGE .
                  docker push $IMAGE
                  echo "SERVER_IMAGE=${IMAGE}" >> $GITHUB_ENV

            - name: build, push docker image (client)
              run: |
                  cd client/stage/
                  IMAGE=${{ secrets.DOCKER_REGISTRY }}/${{ inputs.client_image }}:${{ inputs.image_tag }}
                  docker build -t $IMAGE .
                  docker push $IMAGE
                  echo "CLIENT_IMAGE=${IMAGE}" >> $GITHUB_ENV

            - name: start docker
              run: |
                  REPO=${{ inputs.repo }} \
                  SERVER_IMAGE=${{ env.SERVER_IMAGE }} \
                  SERVER_PORT=${{ secrets.SERVER_PORT }} \
                  CLIENT_IMAGE=${{ env.CLIENT_IMAGE }} \
                  CLIENT_PORT=${{ secrets.CLIENT_PORT }} \
                  docker compose up -d

            - name: configure, restart nginx
              if: github.ref_name == 'main'
              run: |
                  sed -e "s/{SERVER_PORT}/${{ secrets.SERVER_PORT }}/g" \
                    -e "s/{CLIENT_PORT}/${{ secrets.CLIENT_PORT }}/g" \
                    wealthwatch.conf > wealthwatch.conf.tmp
                  mv wealthwatch.conf.tmp wealthwatch.conf
                  cp wealthwatch.conf /usr/local/etc/nginx/servers/
                  nginx -t
                  brew services restart nginx
