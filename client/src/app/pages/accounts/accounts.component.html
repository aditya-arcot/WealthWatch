<app-loading-spinner [loading]="loading"></app-loading-spinner>

<div class="container-fluid position-relative mb-3">
    <h2 class="text-center mb-0">Accounts</h2>
    <button
        (click)="linkAccount()"
        class="btn btn-success position-absolute top-left"
        type="button"
        title="Link Account"
    >
        <i class="bi bi-plus"></i>
        <span class="ms-1 d-none d-sm-inline">Link an Account</span>
    </button>
</div>

@if (!itemsWithAccounts.length) {
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-10 col-sm-8 col-md-6 col-xl-4">
                <div class="card mb-2">
                    <div class="card-body">
                        <h4 class="text-center mb-0">No accounts linked</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
} @else {
    @for (item of itemsWithAccounts; track $index) {
        <div class="card mb-2">
            <div class="card-body">
                <div class="container-fluid position-relative mb-2 p-0">
                    <h5 class="card-title mb-1">{{ item.institutionName }}</h5>
                    <h6
                        class="card-subtitle mb-1 small-text"
                        [class.text-success]="item.healthy"
                        [class.text-danger]="!item.healthy"
                    >
                        @if (item.healthy) {
                            Healthy
                        } @else {
                            Unhealthy
                        }
                    </h6>
                    <h6 class="card-subtitle text-muted small-text">
                        @if (!item.lastSynced) {
                            Never synced
                        } @else {
                            Last synced:
                            {{ getFormattedDate(item.lastSynced) }}
                        }
                    </h6>

                    <div class="d-flex gap-2 position-absolute top-right">
                        <button
                            (click)="refreshItem(item)"
                            class="btn btn-primary"
                            type="button"
                            title="Refresh"
                        >
                            <i class="bi bi-arrow-clockwise"></i>
                            <span class="ms-1 d-none d-sm-inline">Refresh</span>
                        </button>
                        <button
                            (click)="deactivateItem(item)"
                            class="btn btn-danger"
                            type="button"
                            title="Deactivate"
                        >
                            <i class="bi bi-trash"></i>
                            <span class="ms-1 d-none d-sm-inline">Delete</span>
                        </button>
                    </div>
                </div>

                <table
                    class="table table-striped table-hover table-sm table-bordered mb-0"
                >
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Type</th>
                            <th scope="col">Current Balance</th>
                            <th scope="col" class="d-none d-md-table-cell">
                                Available Balance
                            </th>
                            <th scope="col" class="d-none d-sm-table-cell">
                                Number
                            </th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider small-text">
                        @for (account of item.accounts; track $index) {
                            <tr>
                                <td>{{ account.name }}</td>
                                <td>
                                    {{ account.type }} ({{ account.subtype }})
                                </td>
                                <td>
                                    {{ getFormattedCurrentBalance(account) }}
                                </td>
                                <td class="d-none d-md-table-cell">
                                    {{ getFormattedAvailableBalance(account) }}
                                </td>
                                <td class="d-none d-sm-table-cell">
                                    &middot;&middot;&middot;&middot;
                                    {{ account.mask }}
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}
